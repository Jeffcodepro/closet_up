
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid d-flex justify-content-between align-items-center w-100 m-3">

    <a class="navbar-brand" href="/">Meu Marketplace</a>

    <div class="mx-auto" style="max-width: 500px; width: 100%;">
      <form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar produtos" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">
          <i class="bi bi-search"></i>
        </button>
      </form>
    </div>

    <ul class="navbar-nav d-flex flex-row align-items-center gap-3 ms-auto">
      <% if user_signed_in? %>
        <li class="nav-item">
          <%= link_to orders_path, class: "nav-link text-white" do %>
            Olá, <%= current_user.email %>
          <% end %>
        </li>
        <li class="nav-item d-flex align-items-center">
          <%= link_to "Adicionar Produto", new_product_path, class: "nav-link btn-add-product" %>
        </li>
        <li class="nav-item d-flex align-items-center">
          <%= link_to edit_user_registration_path, class: "nav-link text-white" do %>
            <i class="bi bi-person fs-4"></i>
          <% end %>
        </li>
        <li class="nav-item d-flex align-items-center position-relative">
          <%= link_to cart_path, class: "nav-link text-white position-relative" do %>
            <i class="fa-solid fa-cart-shopping fs-4"></i>
            <% if defined?(current_order) && current_order && current_order.order_items.any? %>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <%= current_order.order_items.sum(:quantity) %>
              </span>
            <% end %>
          <% end %>
        </li>
        <li class="nav-item d-flex align-items-center">
          <%= link_to "Log out", destroy_user_session_path, data: {turbo_method: :delete}, class: "nav-link text-white" %>
        </li>
      <% else %>
        <li class="nav-item d-flex align-items-center">
          <%= link_to "Entrar", new_user_session_path, class: "nav-link text-white" %>
        </li>
        <li class="nav-item d-flex align-items-center">
          <%= link_to "Criar Conta", new_user_registration_path, class: "nav-link text-white" %>
        </li>
      <% end %>
    </ul>

  </div>
</nav>

<nav class="navbar navbar-dark bg-secondary">
  <div class="container-fluid">
    <ul class="navbar-nav d-flex flex-row w-100 justify-content-between overflow-auto">
      <% Category.all.each do |category| %>
        <li class="container nav-item text-center">
          <%= link_to products_by_category_path(category), class: "nav-link text-white px-2" do %>
            <%= category.title %>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
</nav>

<div class="container">
  <h1 class="mb-4">Seu Carrinho</h1>

  <% if @order && @order.order_items.any? %>
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Produto</th>
          <th>Tamanho</th>
          <th>Preço</th>
          <th style="width:120px;">Qtd</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @order.order_items.each do |item| %>
          <tr>
            <td>
              <% if item.product.images.attached? %>
                <% img = item.product.images.first %>
                <%= cl_image_tag img.key,
                      width: 60, height: 60, crop: :fill,
                      class: "me-2 rounded" %>
              <% end %>
              <%= item.product.title %>
            </td>
            <td><%= item.size.presence || "-" %></td>
            <td><%= number_to_currency(item.unit_price_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <%= number_field_tag "quantity", item.quantity, min: 1, class: "form-control rounded-4", style: "width: 60px;" %>
                <%= submit_tag "Atualizar", class: "btn-edit btn-sm rounded-4" %>
              </div>
            </td>
            <td><%= number_to_currency(item.line_total_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
            <td>
              <%= button_to "Remover", order_item_path(item), method: :delete, data: { confirm: "Tem certeza?" }, class: "btn-delete btn-sm" %>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="text-end">Total</th>
          <th>
            <%= number_to_currency(@order.subtotal_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %>
          </th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="mt-3">
        <%= button_to "Ir para checkout", checkout_cart_path, method: :post, class: "btn-go-to-checkout" %>
      </div>
      <div class="mt-3">
        <%= link_to "Continuar comprando", products_path, class: "btn-return-to-products" %>
      </div>
    </div>
  <% else %>
    <p>Seu carrinho está vazio.</p>
    <%= link_to "Ver produtos", products_path, class: "btn-return-to-products" %>
  <% end %>
</div>
