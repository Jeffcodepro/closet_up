<div class="container">
  <h1 class="mb-4 mt-5">Seu Carrinho</h1>

  <% if @order && @order.order_items.any? %>
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Produto</th>
          <th>Tamanho</th>
          <th>Preço</th>
          <th style="width:120px;">Qtd</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @order.order_items.each do |item| %>
          <tr>
            <td>
              <% if item.product.images.attached? %>
                <% img = item.product.images.first %>
                <%= cl_image_tag img.key,
                      width: 60, height: 60, crop: :fill,
                      class: "me-2 rounded" %>
              <% end %>
              <%= item.product.title %>
            </td>
            <td><%= item.size.presence || "-" %></td>
            <td><%= number_to_currency(item.unit_price_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
            <td>
              <%= form_with url: order_item_path(item), method: :patch, local: true do |f| %>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <%= number_field_tag "order_item[quantity]", item.quantity, min: 1, class: "form-control rounded-4", style: "width: 60px;" %>
                  <%= f.submit "Atualizar", class: "btn-edit btn-sm rounded-4" %>
                </div>
              <% end %>
            </td>
            <td><%= number_to_currency(item.line_total_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
            <td>
              <%= button_to "Remover", order_item_path(item), method: :delete, data: { confirm: "Tem certeza?" }, class: "btn-delete btn-sm" %>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="text-end">Total</th>
          <th>
            <%= number_to_currency(@order.subtotal_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %>
          </th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="mt-3">
        <%= button_to "Ir para checkout", checkout_cart_path, method: :post, class: "btn-go-to-checkout" %>
      </div>
      <div class="mt-3">
        <%= link_to "Continuar comprando", products_path, class: "btn-return-to-products" %>
      </div>
    </div>
  <% else %>
    <p>Seu carrinho está vazio.</p>
    <%= link_to "Ver produtos", products_path, class: "btn-return-to-products" %>
  <% end %>
</div>
