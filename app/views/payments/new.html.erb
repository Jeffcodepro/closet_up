

<div class="container">
  <div class="row py-4 g-4">

    <!-- ESQUERDA: Resumo (tabela com TODOS os itens) -->
    <div class="col-md-7">
      <h1 class="h4 mb-3">Resumo do Pedido</h1>

      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Produto</th>
            <th>Tam.</th>
            <th>Qtd</th>
            <th>Unitário</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <% @items.each do |item| %>
            <tr>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <% if item.product.images.attached? %>
                    <% img = item.product.images.first %>
                    <%= cl_image_tag img.key, width: 40, height: 40, crop: :fill, class: "rounded" %>
                  <% end %>
                  <span><%= item.product.title %></span>
                </div>
              </td>
              <td><%= item.size.presence || "-" %></td>
              <td><%= item.quantity %></td>
              <td><%= number_to_currency(item.unit_price_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
              <td><%= number_to_currency(item.line_total_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">Total</th>
            <th><%= number_to_currency(@order.amount_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- DIREITA: Infos e botão de pagamento -->
    <div class="col-md-5 mt-4">
      <h2 class="h4 mb-3">Informações da Compra</h2>

      <ul class="list-unstyled mb-3">
        <li class="d-flex justify-content-between">
          <span>Itens</span>
          <strong><%= @items.to_a.sum(&:quantity) %></strong>
        </li>
        <li class="d-flex justify-content-between">
          <span>Total</span>
          <strong><%= number_to_currency(@order.amount_cents / 100.0, unit: "R$ ", separator: ",", delimiter: ".") %></strong>
        </li>
      </ul>

      <button id="pay" class="btn-buy-product w-100">Finalizar a compra</button>

      <script src="https://js.stripe.com/v3/"></script>
      <script>
        document.addEventListener('turbo:load', setupStripe);
        document.addEventListener('DOMContentLoaded', setupStripe);
        function setupStripe() {
          const btn = document.getElementById('pay');
          if (!btn) return;
          btn.addEventListener('click', () => {
            const stripe = Stripe('<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>');
            stripe.redirectToCheckout({ sessionId: '<%= @order.checkout_session_id %>' });
          });
        }
      </script>
    </div>

  </div>
</div>
